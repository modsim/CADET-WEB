{% extends 'simulation/base.html' %}

{% block body %}

{% for item, tag, hdf5_path, graphs_available in selected %}
<p> {{ item }}  {{ tag }}  {{ hdf5_path }}  {{graphs_available}}</p>
                        {% endfor %}
    {% for id, name in graphs_common %}

<div class="jumbotron graph_wide">
    <h3>{{ name }}</h3>
    <div>
        <div class="row graph_row">
            <div class="x_label">Time(s)</div>
            <div class="y_label">Concentration (mMol)</div>
            <div class="col-md-9 tall" id="{{ id }}"></div>
            <div class="col-md-3 tall" id="{{ id }}choice"></div>
        </div>
        <div class="row">
            <div class="col-md-9 small" id="{{ id }}overview"></div>
        </div>
    </div>
</div>

    {% endfor %}



<script type="text/javascript">

    $("body").addClass("loading");

    function start_plot(datasets, element, choices, overview_id, base_id) {
        // hard-code color indices to prevent them from shifting as
        // countries are turned on/off
        var datasets = datasets;
        var i = 0;
        $.each(datasets, function (key, val) {
            val.color = i;
            ++i;
        });

        // insert checkboxes
        var choiceContainer = $(choices);

        choiceContainer.prepend("<br/><a href='#' role='button' class='btn btn-default' id='" + base_id + "download'>Download Current Graph</a>");
        choiceContainer.prepend("<br/><a href='#' role='button' class='btn btn-default' id='" + base_id + "zoom'>Reset Zoom</a>");

        for (var key in datasets) {
            choiceContainer.prepend("<br/><input type='checkbox' name='" + key +
				"' checked='checked' id='id" + key + "'></input>" +
				"<label for='id" + key + "'>"
				+ datasets[key].label + "</label>");
        };

        choiceContainer.find("input").click(plotAccordingToChoices);

        $('#' + base_id + 'zoom').click(function (e) {
            plotAccordingToChoices();
            e.preventDefault();
        });

        $('#' + base_id + 'download').click(function (e) {
            var link = $('#' + base_id + 'download');
            var search = element + ' > canvas:first';
            console.log(search);
            //link.href = $("'" + element + ' > canvas:first' + "'")[0].toDataURL();
            link.attr('href', $(search)[0].toDataURL());
            link.attr('download', base_id + '.png');
            //e.preventDefault();
        });

        function plotAccordingToChoices() {

            var data = [];

            choiceContainer.find("input:checked").each(function () {
                var key = $(this).attr("name");
                if (key && datasets[key]) {
                    data.push(datasets[key]);
                }
            });

            var plot = $.plot(element, data, {
                canvas: true,
                yaxis: {
                    //min: 0,
                    //zoomRange: null,
                    //panRange: [0, maxY]
                },
                y2axis: {
                    //min: 0,
                    //zoomRange: null,
                    //panRange: [0, maxY]
                },
                xaxis: {
                    //tickDecimals: 0,
                    //zoomRange: null,
                    //panRange: [0, maxX]
                },
                zoom: {
                    interactive: true
                },
                pan: {
                    interactive: false
                },
                selection: {
                    mode: "xy"
                },
                yaxes: [{}, { position: "right" }]
            });

            var overview = $.plot(overview_id, data, {
                canvas: true,
                xaxis: {
                    ticks: [],
                },
                yaxis: {
                    ticks: [],
                    autoscaleMargin: 0.1
                },
                selection: {
                    mode: "x"
                }
            });

            // now connect the two

            $(element).bind("plotselected", function (event, ranges) {

                // do the zooming
                $.each(plot.getXAxes(), function (_, axis) {
                    var opts = axis.options;
                    opts.min = ranges.xaxis.from;
                    opts.max = ranges.xaxis.to;
                });
                plot.setupGrid();
                plot.draw();
                plot.clearSelection();

                // don't fire event on the overview to prevent eternal loop

                overview.setSelection(ranges, true);
            });

            $(overview_id).bind("plotselected", function (event, ranges) {
                plot.setSelection(ranges);
            });

        }

        plotAccordingToChoices();
    }

    $(document).ready(function () {
        var data;

        function fetchData() {

            function onDataReceived(json_data) {

                // Load all the data in one pass; if we only got partial
                // data we could merge it with what we already have.
                data = json_data;

                if (1 == json_data['failed']) {
                    $("#success").remove();
                    $("body").removeClass("loading");
                } else if (0 == json_data['success']) {
                    $("#progress").load("{{ progress }}");
                    setTimeout(fetchData, 5000);
                } else {
                    $("#failed").remove();
                    $("body").removeClass("loading");

                    document.getElementById("stdout").innerHTML = ansi_up.ansi_to_html(json_data['stdout']);
                    document.getElementById("stderr").innerHTML = ansi_up.ansi_to_html(json_data['stderr']);

                    $('#cadet_version').text(json_data['cadet_version']);
                    $('#cadet_git_version').prop('title', 'Git Version Commit String: ' + json_data['cadet_git_version']);

                    for (var key in json_data['data']) {
                        if (json_data['data'].hasOwnProperty(key)) {
                            start_plot(json_data['data'][key], "#" + key, "#" + key + 'choice', "#" + key + 'overview', key);
                        }
                    }

                }
            }

            $.ajax({
                url: "{{ json_url }}",
                type: "GET",
                dataType: "json",
                cache: false,
                data: { 'path': '{{ path }}', 'sim_id': '{{ sim_id }}' },
                success: onDataReceived
            });
        }

        fetchData();
    });
</script>

{% endblock %}
{% extends 'simulation/base.html' %}

{% block body %}

{% for id, name in graphs_common %}

<div class="jumbotron graph_wide">
    <h3>{{ name }}</h3>
    <div>
        <div class="row graph_row">
            <div class="x_label">Time(s)</div>
            <div class="y_label">Concentration (mMol)</div>
            <div class="col-md-9 tall" id="{{ id }}"></div>
            <div class="col-md-3 tall" id="{{ id }}choice"></div>
        </div>
        <div class="row">
            <div class="col-md-9 small" id="{{ id }}overview"></div>
        </div>
    </div>
</div>

{% endfor %}



<script type="text/javascript">

    $("body").addClass("loading");

    var colors = ['Black', 'Red', 'Blue', 'Lime', 'Cyan', 'BlueViolet', 'Crimson', 'DeepPink', 'DarkMagenta', 'Green',
        'Indigo', 'Magenta', 'MidnightBlue', 'Orange', 'Purple', 'Silver', 'Tan'];

    function start_plot(datasets, element, choices, overview_id, base_id) {
        // hard-code color indices to prevent them from shifting
        var datasets = datasets;
        var i = 0;
        $.each(datasets.components, function (key, val) {
            val.color = colors[i%colors.length];
            ++i;
        });

        // insert checkboxes
        var choiceContainer = $(choices);
        //choiceContainer.prepend("<br/><a href='#' role='button' class='btn btn-default' id='" + base_id + "download'>Download Current Graph</a>");
        choiceContainer.prepend("<br/><a href='#' role='button' class='btn btn-default' id='" + base_id + "zoom'>Reset Zoom</a>");
        console.log(3);
        for (var key in datasets['components']) {
            choiceContainer.prepend("<br/><input type='checkbox' name='" + key +
				"' checked='checked' id='id" + base_id + key + "'></input>" +
				"<label for='id" + base_id + key + "'>"
				+ key + "</label>");
        };
        console.log(4);
        choiceContainer.find("input").click(plotAccordingToChoices);
        console.log(5);
        $('#' + base_id + 'zoom').click(function (e) {
            plotAccordingToChoices();
            e.preventDefault();
        });
        console.log(6);
        $('#' + base_id + 'download').click(function (e) {
            var link = $('#' + base_id + 'download');
            var search = element + ' > canvas:first';
            console.log(search);
            //link.href = $("'" + element + ' > canvas:first' + "'")[0].toDataURL();
            link.attr('href', $(search)[0].toDataURL());
            link.attr('download', base_id + '.png');
            //e.preventDefault();
        });
        console.log(7);
        function plotAccordingToChoices() {

            var data = [];

            choiceContainer.find("input:checked").each(function () {
                var key = $(this).attr("name");
                if (key && datasets[key]) {
                    data.push(datasets[key]);
                }
            });

            var plot = $.plot(element, data, {
                canvas: true,
                yaxis: {
                    //min: 0,
                    //zoomRange: null,
                    //panRange: [0, maxY]
                },
                y2axis: {
                    //min: 0,
                    //zoomRange: null,
                    //panRange: [0, maxY]
                },
                xaxis: {
                    //tickDecimals: 0,
                    //zoomRange: null,
                    //panRange: [0, maxX]
                },
                zoom: {
                    interactive: true
                },
                pan: {
                    interactive: false
                },
                selection: {
                    mode: "xy"
                },
                yaxes: [{}, { position: "right" }]
            });

            var overview = $.plot(overview_id, data, {
                canvas: true,
                xaxis: {
                    ticks: [],
                },
                yaxis: {
                    ticks: [],
                    autoscaleMargin: 0.1
                },
                selection: {
                    mode: "x"
                }
            });

            // now connect the two

            $(element).bind("plotselected", function (event, ranges) {

                // do the zooming
                $.each(plot.getXAxes(), function (_, axis) {
                    var opts = axis.options;
                    opts.min = ranges.xaxis.from;
                    opts.max = ranges.xaxis.to;
                });
                plot.setupGrid();
                plot.draw();
                plot.clearSelection();

                // don't fire event on the overview to prevent eternal loop

                overview.setSelection(ranges, true);
            });

            $(overview_id).bind("plotselected", function (event, ranges) {
                plot.setSelection(ranges);
            });

        }
        console.log(8);
        //plotAccordingToChoices();
    }

    $(document).ready(function () {
        var data;

        function fetchData() {

            function onDataReceived(json_data) {
                data = json_data.comparison_data;

                $("body").removeClass("loading");
                for (var key in data) {
                    start_plot(data[key], "#" + key, "#" + key + 'choice', "#" + key + 'overview', key);
                }

                
            }

            $.ajax({
                url: "{{ json_url }}",
                type: "GET",
                dataType: "json",
                cache: false,
                data: { 'selected': '{{ selected_jobs }}'  },
                success: onDataReceived
            });
        }

        fetchData();
    });
</script>

{% endblock %}